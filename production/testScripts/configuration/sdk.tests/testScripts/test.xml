<?xml version="1.0" encoding="UTF-8"?>
<project
  name="Automated Eclipse Testing in Production"
  default="all"
  basedir=".">

  <!--Directory name of org.eclipse.test plug-in installed in ${eclipse-home} -->
  <target
    name="setup"
    unless="noclean"
    depends="init">

    <!--Kill msedgewebview2.exe processes on windows to troubleshoot https://github.com/eclipse-platform/eclipse.platform.ui/issues/2620-->
    <exec osfamily="windows" executable="taskkill">
      <arg line="/im msedgewebview2.exe /f /t"/>
    </exec>

    <condition
      property="setupTarget"
      value="setup-zip">
      <contains
        string="${runtimeArchive}"
        substring=".zip" />
    </condition>
    <condition
      property="setupTarget"
      value="setup-tar.gz">
      <contains
        string="${runtimeArchive}"
        substring=".tar.gz" />
    </condition>
    <condition
      property="setupTarget"
      value="setup-dmg">
      <contains
        string="${runtimeArchive}"
        substring=".dmg" />
    </condition>

   <condition
      property="extraIU"
      value="org.eclipse.equinox.p2.discovery.feature.feature.group">
      <equals
        arg1="${testPlugin}"
        arg2="org.eclipse.equinox.p2.tests.discovery" />
    </condition>

    <condition
      property="extraIU"
      value="org.eclipse.test.feature.group">
      <equals
        arg1="${testPlugin}"
        arg2="org.eclipse.pde.build.tests" />
    </condition>

    <condition
      property="extraIU"
      value="org.eclipse.unittest.ui">
      <equals
        arg1="${testPlugin}"
        arg2="org.eclipse.ua.tests.doc" />
    </condition>

    <antcall target="setupRepo" />
    <antcall target="${setupTarget}" />

    <antcall target="installPreferences">
      <param
        name="eclipse-home"
        value="${eclipse-home}/eclipse" />
    </antcall>
    <antcall target="installExtraPlugins" />
    <antcall target="installTestPlugins" />

  </target>

  <target
    name="installPreferences">
    <property
      name="preferenceDirectory"
      value="${eclipse-home}/configuration/.settings/" />
    <mkdir dir="${preferenceDirectory}" />
    <echo message="[PREFS] made preferenceDirectory at ${preferenceDirectory}" />
    <antcall target="installNetworkPreferences" />

  </target>


  <target
    name="installNetworkPreferences"
    if="org.eclipse.core.net.prefs">
    <echo
      message="${org.eclipse.core.net.prefs}"
      file="${preferenceDirectory}/org.eclipse.core.net.prefs" />
    <!-- TODO: be sure to check if quoted properly -->
    <echo message="[PREFS] wrote ${org.eclipse.core.net.prefs} to ${preferenceDirectory}" />
  </target>

  <!--Extract test bundles repo -->
  <target
    name="setupRepo"
    depends="init"
    unless="testRepoCreated">
    <mkdir dir="${repoLocation}" />
    <exec
      dir="${basedir}"
      executable="unzip"
      failonerror="false"
      resultproperty="unzipResultCode">
      <arg value="-o" />
      <arg value="-qq" />
      <arg value="${repoZip}" />
      <arg value="-d" />
      <arg value="${repoLocation}" />
    </exec>
    <echo message="unzip resultcode: ${unzipResultCode}" />
    <!-- TODO: can do more checking here, if successful, before we set to value -->
    <property
      name="testRepoCreated"
      value="true" />
  </target>

  <!--setup for zip archives -->
  <target
    name="setup-zip"
    depends="init"
    description="Reinstall the test Eclipse installation if specified by user">
    <condition property="runtimeArchiveExists">
      <available file="${executionDir}/${runtimeArchive}" />
    </condition>
    <fail
      unless="runtimeArchiveExists"
      message="runtime archive (SDK) did not exist where expected. runtimeArchive: ${executionDir}/${runtimeArchive}" />
    <echo message="Deleting existing ${eclipse-home}, if any." />
    <delete
      dir="${eclipse-home}"
      verbose="false" />
    <echo message="Fresh extract ${runtimeArchive} into ${install} for testing." />
    <exec
      dir="${install}"
      executable="unzip">
      <arg value="-q" />
      <arg path="${executionDir}/${runtimeArchive}" />
      <arg value="-d" />
      <arg path="${install}" />
    </exec>

  </target>

  <!--setup for tar.gz archives -->
  <target
    name="setup-tar.gz"
    depends="init"
    description="Reinstall the test Eclipse installation if specified by user">
    <condition property="runtimeArchiveExists">
      <available file="${executionDir}/${runtimeArchive}" />
    </condition>
    <fail
      unless="runtimeArchiveExists"
      message="runtime archive (SDK) did not exist where expected. runtimeArchive: ${executionDir}/${runtimeArchive}" />
    <echo message="Deleting existing ${eclipse-home}, if any." />
    <delete
      dir="${eclipse-home}"
      verbose="false" />

    <echo message="Fresh extract ${runtimeArchive} into ${install} for testing." />
    <exec
      dir="${install}"
      executable="tar">
      <arg value="-xf" />
      <arg path="${executionDir}/${runtimeArchive}" />
      <arg value="-C" />
      <arg path="${install}" />
    </exec>

  </target>

  <!--setup for dmg archives -->
  <target
    name="setup-dmg"
    depends="init"
    description="Reinstall the test Eclipse installation if specified by user">
    <condition property="runtimeArchiveExists">
      <available file="${executionDir}/${runtimeArchive}" />
    </condition>
    <fail
      unless="runtimeArchiveExists"
      message="runtime archive (SDK) did not exist where expected. runtimeArchive: ${executionDir}/${runtimeArchive}" />
    <echo message="Deleting existing ${eclipse-home}, if any." />
    <delete
      dir="${eclipse-home}"
      verbose="false" />

    <echo message="Fresh extract ${runtimeArchive} into ${install} for testing." />
    <exec
      dir="${install}"
      executable="hdiutil">
      <arg value="attach" />
      <arg path="${executionDir}/${runtimeArchive}" />
    </exec>
    <exec
      dir="${install}"
      executable="cp">
      <arg value="-r" />
      <arg path="/Volumes/Eclipse/Eclipse.app" />
      <arg path="${install}/" />
    </exec>
    <exec
      dir="${install}"
      executable="hdiutil">
      <arg value="detach" />
      <arg path="/Volumes/Eclipse" />
    </exec>
    <exec
      dir="${install}"
      executable="xattr">
      <arg value="-rc" />
      <arg path="${install}/Eclipse.app" />
    </exec>

  </target>

  <target name="setupPlatform">
    <condition
      property="platformTarget"
      value="platform-zip">
      <contains
        string="${platformArchive}"
        substring=".zip" />
    </condition>
    <condition
      property="platformTarget"
      value="platform-tar.gz">
      <contains
        string="${platformArchive}"
        substring=".tar.gz" />
    </condition>
    <condition
      property="platformTarget"
      value="platform-dmg">
      <contains
        string="${platformArchive}"
        substring=".dmg" />
    </condition>
    <fail
      unless="platformTarget"
      message="platformTarget is not defined. Check that platformArchive variable and value is defined correctly, such as in equinoxp2tests.properties in the appropriate testConfig" />
    <echo message="platformTarget ${platformTarget} platformArchive ${platformArchive}" />
    <!-- The "platformArchive" is a minimal, stable version of eclipse runtime binary,
      that is used only for its "p2Director" application, to install tests into
      to target test environment. The intent is to make sure that apart of the tests
      works consistently, and does not "break the tests", simply because of some recent
      but in p2Director. (while unlikely, these days ... since that code is not under active
      development ... you never know). We test for both "Eclipse.app" and "eclipse.app"
      since the case of our app may change, and the file system of MacOSX may or may 
      not be set to "case sensitive".
    -->
    <condition property="basePlatformInstalled">
      <or>
        <available file="${platformLocation}/eclipse" />
        <available file="${platformLocation}/Eclipse.app" />
        <available file="${platformLocation}/eclipse.app" />
      </or>
    </condition>
    <antcall target="${platformTarget}" />
    <antcall target="installPreferences">
      <param
        name="eclipse-home"
        value="${platformLocation}/eclipse" />
    </antcall>
  </target>


  <!--setup for platform zip archives -->
  <target
    name="platform-zip"
    unless="basePlatformInstalled"
    depends="init"
    description="Install the base binary platform installation">
    <condition property="platformArchiveExists">
      <available file="${platformLocation}/${platformArchive}" />
    </condition>
    <fail
      unless="platformArchiveExists"
      message="plaform archive did not exist where expected. platformArchive: ${platformLocation}/${platformArchive}" />
    <!-- remove eclipse home directory, to be sure completely fresh -->
    <delete
      verbose="false"
      dir="${platformLocation}/eclipse" />
    <exec
      dir="${platformLocation}"
      executable="unzip">
      <arg value="-q" />
      <arg path="${platformLocation}/${platformArchive}" />
      <arg value="-d" />
      <arg path="${platformLocation}" />
    </exec>
  </target>

  <!--setup for platform tar.gz archives -->
  <target
    name="platform-tar.gz"
    unless="basePlatformInstalled"
    depends="init"
    description="Install the base binary platform installation">
    <condition property="platformArchiveExists">
      <available file="${platformLocation}/${platformArchive}" />
    </condition>
    <fail
      unless="platformArchiveExists"
      message="plaform archive did not exist where expected. platformArchive: ${platformLocation}/${platformArchive}" />
    <delete
      verbose="false"
      dir="${platformLocation}/eclipse" />
    <exec
      dir="${platformLocation}"
      executable="tar">
      <arg value="-xf" />
      <arg path="${platformLocation}/${platformArchive}" />
      <arg value="-C" />
      <arg path="${platformLocation}" />
    </exec>
  </target>

  <!--setup for dmg archives -->
  <target
    name="platform-dmg"
    unless="basePlatformInstalled"
    depends="init"
    description="Install the base binary platform installation">
    <condition property="platformArchiveExists">
      <available file="${platformLocation}/${platformArchive}" />
    </condition>
    <fail
      unless="platformArchiveExists"
      message="plaform archive did not exist where expected. platformArchive: ${platformLocation}/${platformArchive}" />
    <delete
      verbose="false"
      dir="${platformLocation}/eclipse" />
    <echo message="Fresh extract ${runtimeArchive} into ${install} for testing." />
    <exec
      dir="${platformLocation}"
      executable="hdiutil">
      <arg value="attach" />
      <arg path="${platformLocation}/${platformArchive}" />
    </exec>
    <exec
      dir="${platformLocation}"
      executable="cp">
      <arg value="-r" />
      <arg path="/Volumes/Eclipse/Eclipse.app" />
      <arg path="${platformLocation}/" />
    </exec>
    <exec
      dir="${platformLocation}"
      executable="hdiutil">
      <arg value="detach" />
      <arg path="/Volumes/Eclipse" />
    </exec>
    <exec
      dir="${platformLocation}"
      executable="xattr">
      <arg value="-rc Eclipse.app" />
    </exec>
  </target>


  <target
    name="installExtraPlugins"
    depends="init"
    if="extraIU">

    <path id="launcher.paths">
      <fileset
        dir="${eclipse-home}"
        includes="plugins/org.eclipse.equinox.launcher_*" />
    </path>
    <property
      name="launcherPath"
      refid="launcher.paths" />


    <echo>-installExtraIU ${extraIU} +</echo>
    <echo> from current.build.repo: ${current.build.repo} </echo>
    <echo> into eclipse-home: ${eclipse-home} </echo>
    <echo> using launcher: ${launcherPath} </echo>
    <java
      jar="${launcherPath}"
      failonerror="false"
      dir="${eclipse-home}"
      timeout="900000"
      fork="true"
      output="${directorLogs}/director-${extraIU}.log"
      append="true"
      resultproperty="directorcode">
      <arg value="-vm" />
      <arg path="${java.home}/bin/java" />
      <arg value="-application" />
      <arg value="org.eclipse.equinox.p2.director" />
      <arg value="-consoleLog" />
      <arg value="-debug" />
      <arg value="-flavor" />
      <arg value="tooling" />
      <arg value="-installIUs" />
      <arg value="${extraIU}" />
      <arg value="-repository" />
      <arg value="${current.build.repo}" />
    </java>
  </target>

  <target
    name="installTestPlugins"
    depends="init">
    <path id="launcher.paths">
      <fileset
        dir="${eclipse-home}"
        includes="plugins/org.eclipse.equinox.launcher_*" />
    </path>
    <property
      name="launcherPath"
      refid="launcher.paths" />
    <antcall target="setupPlatform" />
    <antcall target="installPreferences">
      <param
        name="eclipse-home"
        value="${eclipse-home}" />
    </antcall>
    <echo>-installTestIU ${testPlugin} +</echo>
    <echo> from ${repoLocation} </echo>
    <echo> into ${eclipse-home} </echo>
    <echo> using launcher: ${launcherPath} </echo>
    <java
      jar="${launcherPath}"
      failonerror="false"
      dir="${eclipse-home}"
      timeout="900000"
      fork="true"
      output="${directorLogs}/director-${testPlugin}.log"
      append="true"
      resultproperty="directorcode">
      <arg value="-vm" />
      <arg path="${java.home}/bin/java" />
      <arg value="-application" />
      <arg value="org.eclipse.equinox.p2.director" />
      <arg value="-consoleLog" />
      <arg value="-debug" />
      <arg value="-flavor" />
      <arg value="tooling" />
      <arg value="-installIUs" />
      <arg
        value="${testPlugin},org.eclipse.test,org.eclipse.ant.optional.junit,org.eclipse.test.performance,org.eclipse.test.performance.win32" />
      <arg value="-repository" />
      <arg value="file:${repoLocation}" />
    </java>

  </target>

  <target
    name="initWorkspace"
    unless="WORKSPACE">
    <property environment="env" />
    <condition
      property="WORKSPACE"
      value="${env.WORKSPACE}"
      else="${basedir}">
      <isset property="env.WORKSPACE" />
    </condition>
  </target>
  <target
    name="initProductionProperties"
    unless="productionPropertiesInitialized"
    depends="initWorkspace">
    <!--
      during production testing, previous steps persists some properties
      that we would otherwise not have access too. Such as those set on
      Hudson command line.
    -->
    <property file="${WORKSPACE}/production.properties" />

    <echo message="eclipseStreamMajor: ${eclipseStreamMajor}"/>
    <echo message="eclipseStreamMinor: ${eclipseStreamMinor}"/>
    <fail unless="eclipseStreamMajor"
      message="eclipseStreamMajor not defined or computable" />
    <fail unless="eclipseStreamMinor"
      message="eclipseStreamMinor not defined or computable" />

    <property name="productionPropertiesInitialized" value="true" />
  </target>

  <target
    name="initBuildType"
    unless="buildType">

    <fail
      unless="buildId"
      message="buildId value must be provided by caller (such as 'I20120717-0800'" />
    <!--
      this "buildId check" may be overly strict, but best to start off strict for now,
      loosen in future if we start to find/have variety
    -->
    <condition property="buildIdOK">
      <matches
        pattern="^[IMXYNPSRU]\d{8}-\d{4}$"
        string="${buildId}" />
    </condition>
    <fail
      message="buildId variable had unexpected format. Should be of the form  [IMXYNPSRU] 8 digits '-' 4 digits, but was ${buildId}"
      unless="buildIdOK" />

    <loadresource property="buildType">
      <string value="${buildId}"/>
      <filterchain>
        <tokenfilter>
          <replaceregex pattern="^([IMXYNPSRU])(\d{8})-(\d{4})$" replace="\1"/>
        </tokenfilter>
      </filterchain>
    </loadresource>
    <echo message="buildType: ${buildType}"/>

   <loadresource property="buildIdTimestamp">
      <string value="${buildId}"/>
      <filterchain>
        <tokenfilter>
          <replaceregex pattern="^([IMXYNPSRU])(\d{8})-(\d{4})$" replace="\2\3"/>
        </tokenfilter>
      </filterchain>
    </loadresource>
    <echo message="buildIdTimestamp: ${buildIdTimestamp}"/>


    <fail unless="buildType" />
  </target>
  <target
    name="initCurrentUpdateSite"
    depends="initDownloadHosts, initProductionProperties, initBuildType"
    unless="currentUpdateSite">
    <property
      name="currentUpdateSite"
      value="https://${DOWNLOAD_HOST}/eclipse/updates/${updateSiteSegment}-${buildType}-builds/${buildId}" />
  </target>

  <target
    name="initBasicDirectories"
    depends="initWorkspace, initInstallDir, initEclipseHome"
    unless="basicDirectoriesInitialized">

    <fail
      unless="buildId"
      message="buildId value must be provided by caller (such as 'I20120717-0800'" />

    <property environment="env" />

    <property
      name="repoZip"
      value="${executionDir}/eclipse-junit-tests-${buildId}.zip" />
    <echo message="repoZip: ${repoZip}" />

    <property
      name="repoLocation"
      value="${executionDir}/testRepo" />
    <echo message="repoLocation: ${repoLocation}" />


    <property
      name="platformLocation"
      value="${executionDir}/platformLocation" />
    <mkdir dir="${platformLocation}" />
    <echo message="platformLocation: ${platformLocation}" />

    <!-- The directory that will contain all files containing information on the tests that ran. -->
    <property
      name="results"
      value="${executionDir}/results" />
    <mkdir dir="${results}" />
    <mkdir dir="${results}/xml" />
    <mkdir dir="${results}/html" />
    <echo message="results: ${results}" />

    <!--Directory for JUnit report output, console log output and .log content for each test suite.
      Overrides default in org.eclipse.test/library.xml -->
    <property
      name="junit-report-output"
      value="${results}/${testedPlatform}" />
    <mkdir dir="${junit-report-output}" />
    <echo message="junit-report-output: ${junit-report-output}" />

    <property
      name="directorLogs"
      value="${results}/${testedPlatform}/directorLogs" />
    <mkdir dir="${directorLogs}" />
    <echo message="directorLogs: ${directorLogs}" />
    
    <property
      name="basicDirectoriesInitialized"
      value="true" />
    <echo message="basicDirectoriesInitialized" />
  </target>

  <!-- this method used only during "unit testing" of this test.xml itself -->
  <target
    name="testCopyFilesIfTesting"
    if="env.TESTING_TEST_XML">
    <echo message="Test of test running on ${osgi.os}" />
    <echo
      message="Reading config from ${WORKSPACE}/eclipse.platform.releng.aggregator/production/testScripts/configuration/sdk.tests/testConfigs/${osgi.os}" />
    <copy todir="${executionDir}">
      <fileset
        dir="${WORKSPACE}/eclipse.platform.releng.aggregator/production/testScripts/configuration/sdk.tests/testConfigs/${osgi.os}" />
    </copy>
  </target>

  <target
    name="initInstallDir"
    depends="checkInstallDir"
    unless="install">
    <property
      name="testDir"
      value="${WORKSPACE}/workarea/${buildId}" />
    <echo message="[DEBUG] in test.xml: testDir: ${testDir}" />

    <property
      name="executionDir"
      value="${testDir}/eclipse-testing" />
    <mkdir dir="${executionDir}" />
    <echo message="[DEBUG] in test.xml: executionDir: ${executionDir}" />

    <!--default directory where test-eclipse-sdk will be installed -->
    <property
      name="install"
      value="${executionDir}/test-eclipse" />
    <mkdir dir="${install}" />
    <echo message="[DEBUG] in test.xml: the value of install was set to: ${install}" />
  </target>

  <target
    name="checkInstallDir"
    if="install">
    <echo message="[DEBUG] in test.xml: Found the value of install already set, to ${install}" />
  </target>

  <!--
    eclipse-home set to be the folder that will later contain the plugins
    folder.
    Note: we have to set eclipse-home, rather than use "eclpse.home" or "eclipse.home.location"
    because at this point we are executing from the "setup" version of eclipse
    (aka basebuilder)
    not the actual version of eclipse we will later be testing.
  -->
  <target
    name="initEclipseHome"
    depends="initInstallDir, checkEclipseHome"
    unless="eclipse-home">

    <condition
      property="eclipse-home"
      value="${install}/Eclipse.app/Contents/Eclipse"
      else="${install}/eclipse">
      <and>
        <os family="mac" />
        <istrue value="${isMacAppLayout}" />
      </and>
    </condition>
    <echo message="[DEBUG] the value of eclipse-home was set to: ${eclipse-home}" />
  </target>

  <!--
    Intended to be called only from initEclipseHome, simply as extra information
    for debugging
  -->
  <target
    name="checkEclipseHome"
    if="eclipse-home">
    <echo message="[DEBUG] Found the value of eclipse-home already set, to ${eclipse-home}" />
  </target>

  <!--
    DOWNLOAD_HOST and ARCHIVE_HOST can be defined on command line,
    if running on local test environments.
  -->
  <target
    name="initDownloadHosts"
    unless="DOWNLOAD_HOST">
    <!-- we assume if "DOWNLOAD_HOST" is defined, then ARCHIVE_HOST has been defined also. -->
    <property environment="env" />
    <echo message="DEBUG: Found DOWNLOAD_HOST not defined. Setting in 'initDownloadHosts'" />
    <echo message="DEBUG:      env.DOWNLOAD_HOST: ${env.DOWNLOAD_HOST}" />
    <condition
      property="DOWNLOAD_HOST"
      value="${env.DOWNLOAD_HOST}"
      else="download.eclipse.org">
      <isset property="env.DOWNLOAD_HOST" />
    </condition>
    <condition
      property="ARCHIVE_HOST"
      value="${env.ARCHIVE_HOST}"
      else="archive.eclipse.org">
      <isset property="env.ARCHIVE_HOST" />
    </condition>
  </target>

  <target
    name="init"
    depends="initWorkspace,initProductionProperties, initBuildType, initDownloadHosts, initCurrentUpdateSite, initBasicDirectories,initPlatformAndRuntimeArchiveName"
    unless="testingIsInitialized">

    <!-- Make sure the values of os, ws, and arch are set. -->
    <fail
      unless="os"
      message="Value of 'os' not specified. 'os' must be set as system property" />
    <fail
      unless="ws"
      message="Value of 'ws' not specified. 'ws' must be set as system property" />
    <fail
      unless="arch"
      message="Value of 'arch' not specified. 'arch' must be set as system property" />

    <property environment="env" />

    <!--
      Normally these files are copied by other scripts, if not simply testing this script with "testTestXMLScript.sh",
      but when testing in isolation, want this simple way to
      copy what we need. Note: the testCopyFileIfTesting target
      will need adjustment, depending on OS that the testing is done on.
    -->
    <antcall target="testCopyFilesIfTesting" />

    <property
      name="current.build.repo"
      value="https://${DOWNLOAD_HOST}/eclipse/updates/${eclipseStreamMajor}.${eclipseStreamMinor}-${buildType}-builds/${buildId}" />
    <echo message="current.build.repo: ${current.build.repo}" />


    <property
      name="last.release.build.repo"
      value="https://${DOWNLOAD_HOST}/eclipse/updates/${previousReleaseVersionRepo}" />
    <echo message="last.release.build.repo: ${last.release.build.repo}" />

    <!--
      test.properties file contains the plugin name including version number,
      and list of required test plug-ins expressed as command-line argument to unzip executable.
      Generated and packaged at build time by CBI custom Maven task.
    -->
    <property file="test.properties" />


    <!--Unlock files on the Mac before starting tests.
      Required to delete some workspace directories (org.eclipse.core.filebuffers.tests and Team CVS tests). -->
    <exec
      dir="${executionDir}"
      executable="chflags"
      os="Mac OS X">
      <arg value="-R" />
      <arg value="nouchg" />
      <arg path="${install}" />
    </exec>

    <!--
      Originally needed/provided for p2 tests, but they appear not to
      be successful in reading or using these properties any longer.
      Not clear why. So we'll leave it in until understood. (It may be
      useful in other scenarios, such when tested stand alone?)
    -->
    <property
      name="org.eclipse.equinox.p2.reconciler.tests.platform.archive"
      value="${executionDir}/${platformArchive}" />

    <property
      name="org.eclipse.equinox.p2.reconciler.tests.platform.archive"
      value="${executionDir}/${platformArchive}" />
    <property
      name="org.eclipse.equinox.p2.tests.current.build.repo"
      value="${current.build.repo}" />
    <property
      name="org.eclipse.equinox.p2.tests.last.release.build.repo"
      value="${last.release.build.repo}" />

    <!--
      It is likely we do not need the equinoxp2propertiesFile any longer,
      during production tests, at least.
    -->
    <antcall target="rewriteEquinoxp2PropertiesFile" />

    <property
      name="testingIsInitialized"
      value="true" />
  </target>

  <target name="rewriteEquinoxp2PropertiesFile">
    <property
      name="EOL"
      value="${line.separator}" />

    <echo
      message="# properties for p2 tests${EOL}"
      file="${executionDir}/equinoxp2tests.properties"
      append="false"
      force="true" />

    <echo
      message="org.eclipse.equinox.p2.reconciler.tests.platform.archive=${org.eclipse.equinox.p2.reconciler.tests.platform.archive}${EOL}"
      file="${executionDir}/equinoxp2tests.properties"
      append="true" />
    <echo
      message="org.eclipse.equinox.p2.tests.current.build.repo=${current.build.repo}${EOL}"
      file="${executionDir}/equinoxp2tests.properties"
      append="true" />
    <echo
      message="org.eclipse.equinox.p2.tests.last.release.build.repo=${last.release.build.repo}${EOL}"
      file="${executionDir}/equinoxp2tests.properties"
      append="true" />
  </target>

  <!-- runtimeArchive is set to the current, just built SDK -->
  <target
    name="initPlatformAndRuntimeArchiveName"
    unless="runtimeArchive">

    <property name="buildIdToUse" value="${buildId}"/>
    <echo message="Set runtimeArchive and platformArchive for os: ${os}, ws: ${ws}, arch: ${arch}" />
    <echo message="build id of runtimeArchive ${buildIdToUse}" />
    <condition
      property="osArchiveNameSuffix"
      value="win32-${arch}.zip">
      <and>
        <equals
          arg1="${os}"
          arg2="win32" />
        <equals
          arg1="${ws}"
          arg2="win32" />
      </and>
    </condition>
    <condition
      property="osArchiveNameSuffix"
      value="linux-gtk-${arch}.tar.gz">
      <and>
        <equals
          arg1="${os}"
          arg2="linux" />
        <equals
          arg1="${ws}"
          arg2="gtk" />
      </and>
    </condition>
    <condition
      property="osArchiveNameSuffix"
      value="macosx-cocoa-${arch}.dmg">
      <and>
        <equals
          arg1="${os}"
          arg2="macosx" />
        <equals
          arg1="${ws}"
          arg2="cocoa" />
      </and>
    </condition>
    <fail
      unless="osArchiveNameSuffix"
      message="osArchiveNameSuffix is not defined. Check that conditions cover os and ws: ${os} ${ws}" />
    <property
      name="runtimeArchive"
      value="eclipse-SDK-${buildIdToUse}-${osArchiveNameSuffix}"/>
    <!--use an stable version of the director so that instability in the current build doesn't cause all the tests to fail -->
    <property
      name="platformArchive"
      value="eclipse-platform-${previousReleaseVersion}-${osArchiveNameSuffix}"
    />
    <echo message="runtimeArchive ${runtimeArchive} !!! " />
  </target>

  <target
    name="setJVMProperties"
    depends="setJVMfromUserSpecified"
    unless="jvm">
    <property
      name="VMSource"
      value="VM used for tests, is same that invoked Ant: '${java.home}/bin/java' (that is, 'jvm' not specified by caller)." />
    <echo message="VMSource: $VMSource" />

    <echo message="full output from 'java -version' of ${java.home}/bin/java is" />
    <exec
      executable="${java.home}/bin/java">
      <arg value="-version" />
    </exec>
  </target>

  <target
    name="setJVMfromUserSpecified"
    if="jvm">

    <property
      name="VMSource"
      value="VM used for tests, specified by caller: 'jvm'=${jvm}" />
    <echo message="VMSource: $VMSource" />
    <echo message="full output from 'java -version' of ${jvm} is" />
    <exec
      executable="${jvm}">
      <arg value="-version" />
    </exec>
  </target>

  <macrodef name="runTests">
    <attribute name="testPlugin" />
    <sequential>
      <antcall target="markCurrentTime">
        <param
          name="message"
          value="start @{testPlugin}" />
      </antcall>

      <property
        name="test.target"
        value="junit" />
      <property
        name="report"
        value="@{testPlugin}" />

      <echo message="test.target in 'runTests': ${test.target}" />

      <!-- <param name="testPlugin" value="${@{testPlugin}}" /> -->
      <antcall target="${test.target}">
        <param
          name="testPlugin"
          value="@{testPlugin}" />
        <param
          name="output-file"
          value="@{testPlugin}.xml" />
      </antcall>
      <antcall target="markCurrentTime">
        <param
          name="message"
          value="end @{testPlugin}" />
      </antcall>
    </sequential>
  </macrodef>

  <target
    name="junit"
    depends="init"
    unless="skip.test">
    <antcall target="setup">
    </antcall>
    <property file="finalPluginsVersions.properties" />
    <property
      name="library-file"
      value="${executionDir}/library.xml" />
    <property
      name="junit-stylesheet"
      value="${executionDir}/JUNIT.XSL" />
    <fileset
      id="plugin.test"
      dir="${eclipse-home}/plugins">
      <filename name="${testPlugin}_*/test.xml" />
    </fileset>
    <property
      name="plugintest"
      refid="plugin.test" />
    <echo>trying to find ${testPlugin}_*/test.xml</echo>
    <condition
      property="plugintest.present"
      value="true">
      <not>
        <equals
          arg1="${plugintest}"
          arg2="" />
      </not>
    </condition>
    <fileset
      id="plugin.jar"
      dir="${eclipse-home}/plugins">
      <filename name="${testPlugin}_*.jar" />
    </fileset>
    <property
      name="pluginjar"
      refid="plugin.jar" />
    <echo>trying to find ${testPlugin}_*.jar</echo>
    <condition
      property="pluginjar.present"
      value="true">
      <not>
        <equals
          arg1="${pluginjar}"
          arg2="" />
      </not>
    </condition>
    <antcall target="extractTestXml" />
    <fileset
      id="test.plugin.file"
      dir="${eclipse-home}/plugins">
      <filename name="${testPlugin}_*/test.xml" />
    </fileset>
    <property
      name="testPluginX"
      refid="test.plugin.file" />
    <echo>trying to find ${testPluginX}</echo>
    <condition
      property="pluginexists"
      value="true">
      <not>
        <equals
          arg1="${testPluginX}"
          arg2="" />
      </not>
    </condition>
    <antcall target="runSuite" />
    <antcall target="genResults" />
  </target>

  <target
    name="extractTestXml"
    if="pluginjar.present"
    unless="plugintest.present">
    <echo>extracting jar</echo>
    <basename property="plugindirectory" file="${eclipse-home}/plugins/${pluginjar}" suffix=".jar"/>
    <unzip src="${eclipse-home}/plugins/${pluginjar}" dest="${eclipse-home}/plugins/${plugindirectory}" overwrite="true">
      <patternset>
       <include name="test.xml"/>
      </patternset>
    </unzip>
  </target>

  <target
    name="runSuite"
    if="pluginexists">
    <ant
      antfile="${eclipse-home}/plugins/${testPluginX}"
      dir="${eclipse-home}" />
  </target>

  <target name="genResults">
    <copy
      file="${eclipse-home}/${report}.xml"
      tofile="${results}/xml/${report}_${testedPlatform}.xml"
      failonerror="false" />
    <property
      name="junit-stylesheet"
      value="${executionDir}/JUNIT.XSL" />
    <!-- some "failures" are "bad enough" that the tests were not unpacked, so style sheet won't exist -->
    <available
      file="${junit-stylesheet}"
      property="stylesheetexists" />
    <antcall target="convertToHTML" />

  </target>

  <target
    name="convertToHTML"
    if="stylesheetexists"
    depends="checkStylesheetexists">
    <xslt
      style="${junit-stylesheet}"
      basedir="${results}/xml"
      destdir="${results}/html"
      filenameparameter="filename">
      <factory>
        <feature name="http://www.oracle.com/xml/jaxp/properties/enableExtensionFunctions" value="true"/>
      </factory>
    </xslt>
  </target>

  <target
    name="checkStylesheetexists"
    unless="stylesheetexists">
    <echo message="ERROR: previous suite test install failed, so style sheet did not exist" />
  </target>

  <target
    name="ant"
    depends="init">
    <runTests testPlugin="org.eclipse.ant.tests.core" />
  </target>

  <target
    name="antui"
    depends="init">
    <runTests testPlugin="org.eclipse.ant.tests.ui" />
  </target>

  <target
    name="compare"
    depends="init">
    <runTests testPlugin="org.eclipse.compare.tests" />
  </target>

  <target
    name="equinoxcommon"
    depends="init">
    <runTests testPlugin="org.eclipse.equinox.common.tests" />
  </target>

  <target
    name="equinoxds"
    depends="init">
    <runTests testPlugin="org.eclipse.equinox.ds.tests" />
  </target>

  <target
    name="debug"
    depends="init">
    <runTests testPlugin="org.eclipse.debug.tests" />
  </target>

  <target
    name="coreresources"
    depends="init">
    <runTests testPlugin="org.eclipse.core.tests.resources" />
  </target>

  <target
    name="coreresourcessaveparticipant"
    depends="init">
    <runTests testPlugin="org.eclipse.core.tests.resources.saveparticipant" />
  </target>

  <target
    name="coreruntime"
    depends="init">
    <runTests testPlugin="org.eclipse.core.tests.runtime" />
  </target>

  <target
    name="osgi"
    depends="init">
    <runTests testPlugin="org.eclipse.osgi.tests" />
  </target>

  <target
    name="corecontenttype"
    depends="init">
    <runTests testPlugin="org.eclipse.core.contenttype.tests" />
  </target>

  <target
    name="coreexpressions"
    depends="init">
    <runTests testPlugin="org.eclipse.core.expressions.tests" />
  </target>

  <target
    name="ltkuirefactoringtests"
    depends="init">
    <runTests testPlugin="org.eclipse.ltk.ui.refactoring.tests" />
  </target>

  <target
    name="ltkcorerefactoringtests"
    depends="init">
    <runTests testPlugin="org.eclipse.ltk.core.refactoring.tests" />
  </target>

  <target
    name="text"
    depends="init">
    <runTests testPlugin="org.eclipse.text.tests" />
  </target>

  <target
    name="jfacetext"
    depends="init">
    <runTests testPlugin="org.eclipse.jface.text.tests" />
  </target>

  <target
    name="jfacedatabinding"
    depends="init">
    <runTests testPlugin="org.eclipse.jface.tests.databinding" />
  </target>

  <target
    name="jface"
    depends="init">
    <runTests testPlugin="org.eclipse.jface.tests" />
  </target>

  <target name="filebuffers">
    <runTests testPlugin="org.eclipse.core.filebuffers.tests" />
  </target>

  <target
    name="jdttext"
    unless="skip.jdttext">
    <runTests testPlugin="org.eclipse.jdt.text.tests" />
  </target>

  <target
    name="relEng"
    depends="init">
    <runTests testPlugin="org.eclipse.releng.tests" />
  </target>

 <target
    name="tips"
    depends="init">
    <runTests testPlugin="org.eclipse.tips.tests" />
  </target>

  <target
    name="ua"
    depends="init">
    <runTests testPlugin="org.eclipse.ua.tests" />
  </target>

  <target
    name="uadoc"
    depends="init">
    <runTests testPlugin="org.eclipse.ua.tests.doc" />
  </target>

  <target
    name="coretestsnet"
    depends="init">
    <runTests testPlugin="org.eclipse.core.tests.net" />
  </target>

  <target
    name="jdtcorecompiler"
    depends="init, setJVMProperties">
    <runTests testPlugin="org.eclipse.jdt.core.tests.compiler" />
  </target>

  <target
    name="jdtapt"
    depends="init,setJVMProperties">
    <runTests testPlugin="org.eclipse.jdt.apt.tests" />
  </target>

  <target
    name="jdtaptpluggable"
    depends="init, setJVMProperties">
    <runTests testPlugin="org.eclipse.jdt.apt.pluggable.tests" />
  </target>


  <target
    name="jdtcorebuilder"
    depends="init, setJVMProperties">
    <runTests testPlugin="org.eclipse.jdt.core.tests.builder" />
  </target>

  <target
    name="jdtcompilertool"
    depends="init, setJVMProperties">
    <runTests testPlugin="org.eclipse.jdt.compiler.tool.tests" />
  </target>

  <target
    name="jdtcompilerapt"
    depends="init, setJVMProperties">
    <runTests testPlugin="org.eclipse.jdt.compiler.apt.tests" />
  </target>

  <target
    name="jdtcoremodel"
    depends="init, setJVMProperties">
    <runTests testPlugin="org.eclipse.jdt.core.tests.model" />
  </target>

  <target
    name="jdtcoreperf"
    depends="init">
    <runTests testPlugin="org.eclipse.jdt.core.tests.performance" />
  </target>

  <target
    name="jdtdebug"
    depends="init">
    <runTests testPlugin="org.eclipse.jdt.debug.tests" />
  </target>

  <target
    name="jdtjdi"
    depends="init">
    <runTests testPlugin="org.eclipse.jdt.debug.jdi.tests" />
  </target>

  <target
    name="jdtui"
    depends="init">
    <runTests testPlugin="org.eclipse.jdt.ui.tests" />
  </target>

  <target
    name="jdtuirefactoring"
    depends="init">
    <runTests testPlugin="org.eclipse.jdt.ui.tests.refactoring" />
  </target>

  <target
    name="pdeui"
    depends="init">
    <runTests testPlugin="org.eclipse.pde.ui.tests" />
  </target>

  <target
	name="pdeua"
	depends="init">
	<runTests testPlugin="org.eclipse.pde.ua.tests" />
  </target>

  <target
    name="pdeuitemplates"
    depends="init">
    <runTests testPlugin="org.eclipse.pde.ui.templates.tests" />
  </target>

  <target
    name="pdegenericeditor"
    depends="init">
    <runTests testPlugin="org.eclipse.pde.genericeditor.extension.tests" />
  </target>

  <target
    name="pdebuild"
    depends="init">
    <property
      name="pdebuild"
      value="true" />
    <runTests testPlugin="org.eclipse.pde.build.tests" />
  </target>

  <target
    name="swt"
    depends="init">
    <runTests testPlugin="org.eclipse.swt.tests" />
  </target>

  <target
    name="teamcore"
    depends="init">
    <runTests testPlugin="org.eclipse.team.tests.core" />
  </target>

  <target
    name="ui"
    depends="init">
    <runTests testPlugin="org.eclipse.ui.tests" />
  </target>

  <target
    name="uinavigator"
    depends="init">
    <runTests testPlugin="org.eclipse.ui.tests.navigator" />
  </target>

  <target
    name="uircp"
    depends="init">
    <runTests testPlugin="org.eclipse.ui.tests.rcp" />
  </target>

  <target
    name="uiforms"
    depends="init">
    <runTests testPlugin="org.eclipse.ui.tests.forms" />
  </target>

  <target
    name="uieditors"
    depends="init">
    <runTests testPlugin="org.eclipse.ui.editors.tests" />
  </target>

  <target
    name="uiperformance"
    depends="init">
    <runTests testPlugin="org.eclipse.ui.tests.performance" />
  </target>

  <target
    name="uiviews"
    depends="init">
    <runTests testPlugin="org.eclipse.ui.tests.views.properties.tabbed" />
  </target>

  <target
    name="uiworkbenchtexteditor"
    depends="init">
    <runTests testPlugin="org.eclipse.ui.workbench.texteditor.tests" />
  </target>

  <target
    name="genericEditor"
    depends="init">
    <runTests testPlugin="org.eclipse.ui.genericeditor.tests" />
  </target>

  <target
    name="urischeme"
    depends="init">
    <runTests testPlugin="org.eclipse.tests.urischeme" />
  </target>

  <target
    name="update"
    depends="init">
    <runTests testPlugin="org.eclipse.update.tests.core" />
  </target>

  <target
    name="pdeapitooling"
    depends="init">
    <runTests testPlugin="org.eclipse.pde.api.tools.tests" />
  </target>

  <target
    name="equinoxsecurity"
    depends="init">
    <runTests testPlugin="org.eclipse.equinox.security.tests" />
  </target>

  <target
    name="equinoxpreferences"
    depends="init">
    <runTests testPlugin="org.eclipse.equinox.preferences.tests" />
  </target>

  <target
    name="equinoxhttpservlet"
    depends="init">
    <runTests testPlugin="org.eclipse.equinox.http.servlet.tests" />
  </target>

  <target
    name="equinoxp2"
    depends="init">
    <echo
      message="DEBUG: org.eclipse.equinox.p2.reconciler.tests.platform.archive: ${org.eclipse.equinox.p2.reconciler.tests.platform.archive} " />

    <runTests testPlugin="org.eclipse.equinox.p2.tests" />
  </target>

  <target
    name="equinoxp2ui"
    depends="init">
    <runTests testPlugin="org.eclipse.equinox.p2.tests.ui" />
  </target>

  <target
    name="equinoxp2discovery"
    depends="init">
    <runTests testPlugin="org.eclipse.equinox.p2.tests.discovery" />
  </target>

  <target
    name="search"
    depends="init">
    <runTests testPlugin="org.eclipse.search.tests" />
  </target>

  <target
    name="pdeds"
    depends="init">
    <runTests testPlugin="org.eclipse.pde.ds.tests" />
  </target>

  <target
    name="pdejunit"
    depends="init">
    <runTests testPlugin="org.eclipse.pde.junit.runtime.tests" />
  </target>

  <target
    name="bidi"
    depends="init">
    <runTests testPlugin="org.eclipse.equinox.bidi.tests" />
  </target>

  <target
    name="e4Core"
    depends="init">
    <runTests testPlugin="org.eclipse.e4.core.tests" />
  </target>

  <target
    name="e4Commands"
    depends="init">
    <runTests testPlugin="org.eclipse.e4.core.commands.tests" />
  </target>

  <target
    name="e4Bindings"
    depends="init">
    <runTests testPlugin="org.eclipse.e4.ui.bindings.tests" />
  </target>

  <target
    name="e4CssCore"
    depends="init">
    <runTests testPlugin="org.eclipse.e4.ui.tests.css.core" />
  </target>

  <target
    name="e4CssSwt"
    depends="init">
    <runTests testPlugin="org.eclipse.e4.ui.tests.css.swt" />
  </target>

  <target
    name="e4UI"
    depends="init">
    <runTests testPlugin="org.eclipse.e4.ui.tests" />
  </target>

  <target
    name="uipluginchecks"
    depends="init">
    <runTests testPlugin="org.eclipse.ui.tests.pluginchecks" />
  </target>

  <target
    name="updateconfigurator"
    depends="init">
    <runTests testPlugin="org.eclipse.update.configurator.tests" />
  </target>

  <target
    name="all"
    depends="init">
    <!--
      <antcall target="relEng" />
      <antcall target="equinoxp2" />
    -->
    <antcall target="quickTests" />
    <antcall target="longRunningTests" />

  </target>

  <target
    name="sdkTests"
    depends="init">
    <antcall target="quickTests" />
    <antcall target="sdkLongRunningTests" />

  </target>

  <target
    name="quickTests"
    depends="init">

    <antcall target="markCurrentTime">
      <param
        name="message"
        value="start quickTests" />
    </antcall>

    <antcall target="markCurrentTime">
      <param
        name="message"
        value="start platform" />
    </antcall>
    <antcall target="platform" />
    <antcall target="markCurrentTime">
      <param
        name="message"
        value="end platform" />
    </antcall>

    <antcall target="markCurrentTime">
      <param
        name="message"
        value="start pde" />
    </antcall>
    <antcall target="pde" />
    <antcall target="pdeapitooling" />
    <antcall target="markCurrentTime">
      <param
        name="message"
        value="end pde" />
    </antcall>

    <antcall target="markCurrentTime">
      <param
        name="message"
        value="start jdt" />
    </antcall>
    <antcall target="jdt" />
    <antcall target="markCurrentTime">
      <param
        name="message"
        value="end jdt" />
    </antcall>

    <antcall target="markCurrentTime">
      <param
        name="message"
        value="end quickTests" />
    </antcall>

  </target>

  <target
    name="longRunningTests"
    depends="init">

    <antcall target="markCurrentTime">
      <param
        name="message"
        value="start longRunningTests" />
    </antcall>

    <antcall target="markCurrentTime">
      <param
        name="message"
        value="start platformLR" />
    </antcall>
    <antcall target="platformLR" />
    <antcall target="markCurrentTime">
      <param
        name="message"
        value="end platformLR" />
    </antcall>

    <antcall target="markCurrentTime">
      <param
        name="message"
        value="start jdtLR" />
    </antcall>
    <antcall target="jdtLR" />
    <antcall target="markCurrentTime">
      <param
        name="message"
        value="end jdtLR" />
    </antcall>
    <antcall target="markCurrentTime">
      <param
        name="message"
        value="start pdeLR" />
    </antcall>
    <antcall target="pdeLR" />
    <antcall target="markCurrentTime">
      <param
        name="message"
        value="end pdeLR" />
    </antcall>
    <antcall target="markCurrentTime">
      <param
        name="message"
        value="end longRunningTests" />
    </antcall>

  </target>

	  <target
	    name="sdkLongRunningTests"
	    depends="init">

	    <antcall target="markCurrentTime">
	      <param
	        name="message"
	        value="start longRunningTests" />
	    </antcall>

	    <antcall target="markCurrentTime">
	      <param
	        name="message"
	        value="start sdkPlatformLR" />
	    </antcall>
	    <antcall target="sdkPlatformLR" />
	    <antcall target="markCurrentTime">
	      <param
	        name="message"
	        value="end sdkPlatformLR" />
	    </antcall>

	    <antcall target="markCurrentTime">
	      <param
	        name="message"
	        value="start jdtLR" />
	    </antcall>
	    <antcall target="jdtLR" />
	    <antcall target="markCurrentTime">
	      <param
	        name="message"
	        value="end jdtLR" />
	    </antcall>
	    <antcall target="markCurrentTime">
	      <param
	        name="message"
	        value="start pdeLR" />
	    </antcall>
	    <antcall target="pdeLR" />
	    <antcall target="markCurrentTime">
	      <param
	        name="message"
	        value="end pdeLR" />
	    </antcall>
	    <antcall target="markCurrentTime">
	      <param
	        name="message"
	        value="end longRunningTests" />
	    </antcall>

	  </target>

  <!--
    admittedly, not quite all of 'platform', but for
    now serves dual purpose of a "short set" of tests, that area
    relatively quick, and relatively reliable on build.eclipse.org hardware
  -->
  <target
    name="platform"
    depends="init">
    <!-- was removed, temporarily, see bug 400385 -->
    <antcall target="relEng" />

    <antcall target="ant" />
    <antcall target="antui" />
    <antcall target="compare" />
    <antcall target="coreruntime" />
    <antcall target="swt" />
    <antcall target="corecontenttype" />
    <antcall target="coreexpressions" />
    <antcall target="coreresourcessaveparticipant" />
    <antcall target="coretestsnet" />
    <antcall target="text" />
    <antcall target="jfacedatabinding" />
    <antcall target="filebuffers" />
    <antcall target="teamcore" />
    <antcall target="uadoc" />
    <antcall target="uieditors" />
    <antcall target="uinavigator" />
    <antcall target="uiworkbenchtexteditor" />
    <antcall target="uipluginchecks" />
    <antcall target="genericEditor" />
    <antcall target="urischeme" />

    <antcall target="equinoxhttpservlet" />
    <antcall target="tips" />
    <antcall target="ua" />
    <antcall target="uiforms" />
    <antcall target="equinoxp2ui" />
    <antcall target="equinoxsecurity" />
    <antcall target="equinoxpreferences" />
    <antcall target="search" />
    <antcall target="debug" />
    <antcall target="e4Core" />
    <antcall target="e4Commands" />
    <antcall target="e4Bindings" />
    <antcall target="e4CssCore" />
    <antcall target="e4CssSwt" />
    <antcall target="e4UI" />
    <antcall target="equinoxcommon" />
    <antcall target="equinoxds" />
    <antcall target="equinoxp2discovery" />
    <antcall target="bidi" />
    <antcall target="ltkuirefactoringtests" />
    <antcall target="ltkcorerefactoringtests" />

    <antcall target="updateconfigurator" />
  </target>

  <!-- this group is "platform tests" that are Long Running
    (or, perhaps hang?, during performance tests.
  -->
  <target
    name="platformLR"
    depends="init">
    <antcall target="osgi" />
    <antcall target="coreresources" />
    <antcall target="equinoxp2" />
    <antcall target="jface" />
    <antcall target="jfacetext" />
    <antcall target="ui" />
    <antcall target="uiperformance" />

    <!-- don't run now, for 4.2. See bug 380553.
      <antcall target="uircp" />
    -->
    <!-- disable for now, bug 398717
      antcall target="uiviews" /
    -->
  </target>

	  <target
	    name="sdkPlatformLR"
	    depends="init">
	    <antcall target="osgi" />
	    <antcall target="coreresources" />
	    <antcall target="equinoxp2" />
	    <antcall target="jface" />
	    <antcall target="ui" />
	    <antcall target="uiperformance" />
	  </target>


  <target
    name="pde"
    depends="init">
    <antcall target="pdeds" />
    <antcall target="pdejunit" />
    <antcall target="pdeui" />
    <antcall target="pdeua" />
    <antcall target="pdeuitemplates" />
    <antcall target="pdegenericeditor" />
  </target>

  <target
    name="pdeLR"
    depends="init">

    <antcall target="pdebuild" />
  </target>

  <target
    name="jdt"
    depends="init">
    <antcall target="jdtcompilertool" />
    <antcall target="jdtcompilerapt" />
    <antcall target="jdttext" />
    <antcall target="jdtcoreperf" />
    <antcall target="jdtcorebuilder" />
    <antcall target="jdtdebug" />
    <antcall target="jdtjdi" />
    <antcall target="jdtapt" />
    <antcall target="jdtaptpluggable" />
  </target>

  <target
    name="jdtLR"
    depends="init">
    <antcall target="jdtui" />
    <antcall target="jdtuirefactoring" />
    <antcall target="jdtcoremodel" />
    <antcall target="jdtcorecompiler" />
  </target>

  <!-- we could put other variables/os checks here, if needed -->
  <target name="checkOS">
    <condition
      property="isMac"
      value="true">
      <os family="mac" />
    </condition>
    <condition
      property="isUnix"
      value="true">
      <os family="unix" />
    </condition>
  </target>
  <macrodef name="markTime">
    <attribute name="msg" />
    <sequential>
      <!--
        we write the message first, with no ${line.separator} so that the timestamp can
        go on same line, and my side-effect writes an EOL
      -->
      <echo
        message="@{msg}     "
        append="true"
        file="${junit-report-output}/testTimes.log" />
      <!-- This executable should run on all unix platforms (Linux, mac) -->
      <exec
        executable="date"
        append="true"
        output="${junit-report-output}/testTimes.log"
        osfamily="unix">
        <arg value="+%s" />
      </exec>
    </sequential>
  </macrodef>
  <target
    name="markCurrentTime"
    depends="checkOS"
    if="isUnix">
    <!-- caller in antcall is expected to supply msg -->
    <property
      name="message"
      value="no message given by caller" />
    <markTime msg="${message}" />
  </target>

</project>
