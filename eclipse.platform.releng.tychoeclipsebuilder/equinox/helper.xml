<project
  name="Build specific targets and properties"
  default="noDefault"
  basedir=".">

  <target
    name="init"
    unless="helperInitialized">

    <fail
      unless="equinoxPostingDirectory"
      message="Root (or parent) of Equinox drop direcotry to be created must be provided." />

    <fail
      unless="eqpublishingContent"
      message="Root of Equinox template and static files must be provided." />

    <fail
      unless="EBuilderDir"
      message="Root of Eclipse Builder (or Tycho Eclipse Builder) must be provided." />

    <property name="TMP" value="${java.io.tmpdir}"/>

    <property
      name="helperInitialized"
      value="true" />

  </target>
  <target
    name="publish"
    depends="init">
    <echo message="[DEBUG] Equinox helper.xml publish starting" />
        <!--
          These two steps were "blindly" copied from previosly eclipsebuilder, buildAll.xml file.
          They were the only two things done for equininox before "publish" was called, so we call
          them as the first step of "publish".
        -->
    <ant antfile="${EBuilderDir}/equinox/buildConfigs/equinox-launchers/build.xml" />
    <antcall target="updateTestManifests" />
  </target>


  <target
    name="updateTestManifests"
    depends="init">
    <echo message="Starting updateTestManifest" />
    <antcall target="updateTestManifest">
      <param
        name="bundle.id"
        value="org.eclipse.equinox.app" />
    </antcall>
    <antcall target="updateTestManifest">
      <param
        name="bundle.id"
        value="org.eclipse.equinox.console" />
    </antcall>
    <antcall target="updateTestManifest">
      <param
        name="bundle.id"
        value="org.eclipse.equinox.supplement" />
    </antcall>
    <antcall target="updateTestManifest">
      <param
        name="bundle.id"
        value="org.eclipse.equinox.device" />
    </antcall>
    <antcall target="updateTestManifest">
      <param
        name="bundle.id"
        value="org.eclipse.equinox.event" />
    </antcall>
    <antcall target="updateTestManifest">
      <param
        name="bundle.id"
        value="org.eclipse.equinox.launcher" />
    </antcall>

    <antcall target="updateTestManifest">
      <param
        name="bundle.id"
        value="org.eclipse.equinox.region" />
    </antcall>

    <antcall target="updateTestManifest">
      <param
        name="bundle.id"
        value="org.eclipse.equinox.metatype" />
    </antcall>
    <antcall target="updateTestManifest">
      <param
        name="bundle.id"
        value="org.eclipse.equinox.useradmin" />
    </antcall>
    <antcall target="updateTestManifest">
      <param
        name="bundle.id"
        value="org.eclipse.osgi" />
    </antcall>
    <antcall target="updateTestManifest">
      <param
        name="bundle.id"
        value="org.eclipse.osgi.util" />
    </antcall>
    <antcall target="updateTestManifest">
      <param
        name="bundle.id"
        value="org.eclipse.osgi.services" />
    </antcall>
    <antcall target="updateTestManifest">
      <param
        name="bundle.id"
        value="org.eclipse.equinox.registry" />
    </antcall>
    <antcall target="updateTestManifest">
      <param
        name="bundle.id"
        value="org.eclipse.equinox.preferences" />
    </antcall>
    <antcall target="updateTestManifest">
      <param
        name="bundle.id"
        value="org.eclipse.equinox.common" />
    </antcall>
    <antcall target="updateTestManifest">
      <param
        name="bundle.id"
        value="org.eclipse.equinox.cm" />
    </antcall>
    <antcall target="updateTestManifest">
      <param
        name="bundle.id"
        value="org.eclipse.equinox.ds" />
    </antcall>
    <antcall target="updateTestManifest">
      <param
        name="bundle.id"
        value="org.eclipse.equinox.http" />
    </antcall>
    <antcall target="updateTestManifest">
      <param
        name="bundle.id"
        value="org.eclipse.equinox.http.jetty" />
    </antcall>
    <antcall target="updateTestManifest">
      <param
        name="bundle.id"
        value="org.eclipse.equinox.jsp.jasper" />
    </antcall>
    <antcall target="updateTestManifest">
      <param
        name="bundle.id"
        value="org.eclipse.equinox.jsp.jasper.registry" />
    </antcall>
    <antcall target="updateTestManifest">
      <param
        name="bundle.id"
        value="org.eclipse.equinox.http.registry" />
    </antcall>
    <antcall target="updateTestManifest">
      <param
        name="bundle.id"
        value="org.eclipse.equinox.http.servlet" />
    </antcall>
    <antcall target="updateTestManifest">
      <param
        name="bundle.id"
        value="org.eclipse.equinox.http.servletbridge" />
    </antcall>
    <antcall target="updateTestManifest">
      <param
        name="bundle.id"
        value="org.eclipse.equinox.servletbridge" />
    </antcall>
    <antcall target="updateTestManifest">
      <param
        name="bundle.id"
        value="org.eclipse.equinox.transforms.hook" />
    </antcall>
    <antcall target="updateTestManifest">
      <param
        name="bundle.id"
        value="org.eclipse.equinox.transforms.xslt" />
    </antcall>
    <antcall target="updateTestManifest">
      <param
        name="bundle.id"
        value="javax.servlet" />
    </antcall>
    <antcall target="updateTestManifest">
      <param
        name="bundle.id"
        value="javax.servlet.jsp" />
    </antcall>
    <antcall target="updateTestManifest">
      <param
        name="bundle.id"
        value="javax.el" />
    </antcall>
    <antcall target="updateTestManifest">
      <param
        name="bundle.id"
        value="org.apache.commons.logging" />
    </antcall>
    <antcall target="updateTestManifest">
      <param
        name="bundle.id"
        value="org.apache.felix.gogo.command" />
    </antcall>
    <antcall target="updateTestManifest">
      <param
        name="bundle.id"
        value="org.apache.felix.gogo.runtime" />
    </antcall>
    <antcall target="updateTestManifest">
      <param
        name="bundle.id"
        value="org.apache.felix.gogo.shell" />
    </antcall>

    <antcall target="updateTestManifest">
      <param
        name="bundle.id"
        value="org.eclipse.equinox.simpleconfigurator" />
    </antcall>
    <antcall target="updateTestManifest">
      <param
        name="bundle.id"
        value="org.eclipse.equinox.concurrent" />
    </antcall>
    <antcall target="updateTestManifest">
      <param
        name="bundle.id"
        value="org.eclipse.equinox.coordinator" />
    </antcall>
    <antcall target="updateTestManifest">
      <param
        name="bundle.id"
        value="org.eclipse.equinox.region" />
    </antcall>
    <antcall target="updateTestManifest">
      <param
        name="bundle.id"
        value="org.eclipse.jetty.continuation" />
    </antcall>
    <antcall target="updateTestManifest">
      <param
        name="bundle.id"
        value="org.eclipse.jetty.security" />
    </antcall>
    <antcall target="updateTestManifest">
      <param
        name="bundle.id"
        value="org.eclipse.jetty.util" />
    </antcall>
    <antcall target="updateTestManifest">
      <param
        name="bundle.id"
        value="org.eclipse.jetty.http" />
    </antcall>
    <antcall target="updateTestManifest">
      <param
        name="bundle.id"
        value="org.eclipse.jetty.http" />
    </antcall>
    <antcall target="updateTestManifest">
      <param
        name="bundle.id"
        value="org.eclipse.jetty.server" />
    </antcall>
    <antcall target="updateTestManifest">
      <param
        name="bundle.id"
        value="org.eclipse.jetty.io" />
    </antcall>
    <antcall target="updateTestManifest">
      <param
        name="bundle.id"
        value="org.eclipse.jetty.servlet" />
    </antcall>
  </target>

  <!-- ===================================================================== -->
  <!-- Helper targets -->
  <!-- ===================================================================== -->
  <target
    name="updateTestManifest"
    depends="init">
    <apply
      executable="ls"
      output="${TMP}/${bundle.id}.txt"
      dir="${equinoxPostingDirectory}/${buildDir}">
      <fileset dir="${equinoxPostingDirectory}/${buildDir}">
        <patternset>
          <include name="${bundle.id}*.jar" />
        </patternset>
      </fileset>
    </apply>

    <replaceregexp
      file="${TMP}/${bundle.id}.txt"
      match="/.+/"
      replace="" />
    <replaceregexp
      file="${TMP}/${bundle.id}.txt"
      match="\.jar"
      replace="" />
    <replaceregexp
      file="${TMP}/${bundle.id}.txt"
      match="\n"
      replace="" />
    <loadfile
      property="bundle.jar"
      srcFile="${TMP}/${bundle.id}.txt"
      failonerror="off" />
    <delete
      file="${TMP}/${bundle.id}.txt"
      failonerror="false" />
    <replace
      file="${eqpublishingContent}/testManifest.xml"
      token="@${bundle.id}@"
      value="${bundle.jar}" />
  </target>


  <!-- ===================================================================== -->
  <!-- Default target                                                        -->
  <!-- ===================================================================== -->
  <target name="noDefault">
    <echo message="You must specify a target when invoking this file" />
  </target>

</project>
