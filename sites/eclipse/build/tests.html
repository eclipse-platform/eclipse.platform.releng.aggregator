<!DOCTYPE html>
<html>

<head>
	<!--TODO: set proper metadata/keywords? -->
	<title>Test Results</title>
	<meta name="keywords" content="eclipse,project,plug-ins,plugins,java,ide,swt,refactoring,free java ide,tools,platform,open source,development environment,development,ide" />
	<link rel="preconnect stylesheet" href="../page.css" /><!-- Replaced by a refernece to a contained copy on deployment -->
	<script src="../page.js"></script><!-- Replaced by a refernece to a contained copy on deployment -->
</head>

<body>
	<div data-generate="generateDefaultBreadcrumb(this, eclipseBreadcrumbBase)">
		<a href="../..">Downloads</a>
		<a class="data-ref" href=".">${label}</a>
		<span>Test Results</span>
	</div>

	<main>
		<h2>Test Results for <a class="data-ref" href=".">${label}</a></h2>
		<h3 id="logs">Logs</h3>
		<ul class="data-ref">
			<li><a href="buildlogs/reporeports/index.html"><b>Repository Reports </b></a></li>
			<li><a href="buildlogs/logs.html"><b>Build and Release Engineering Logs</b></a></li>
			<li><a href="testresults/logs.html"><b>Test Console Logs</b></a></li>
			<li><a href="apitools/analysis/html/index.html"><b>API Tools Version Verification Report</b></a>
				This tool verifies the versions of the plugins against Eclipse ${previousReleaseAPILabel}
				(Exclusions listed in <a href="https://github.com/eclipse-platform/eclipse.platform.releng.aggregator/blob//eclipse.platform.releng.tychoeclipsebuilder/eclipse/apiexclude/exclude_list_external.txt">apiexclude/exclude_list_external.txt</a>).
			</li>
			<li><a href="apitools/deprecation/apideprecation.html"><b>API Tools Deprecation Report</b></a> This tool generates a report for API deprecated since ${previousReleaseAPILabel}.</li>
			<li><a href="apitools/apifilters-${label}.zip"><b>Zip of <samp>.api_filters</samp> files used in the build</b></a></li>
		</ul>
		<h3 id="test-results">Unit Test Results</h3>
		<p>The unit tests are run on the <a id="ci-tests-folder-url" href="https://ci.eclipse.org/releng">RelEng Jenkins instance</a>.</p>
		<p>
			The table shows the unit test results for this build on the platforms tested.
			You may access the test results page specific to each component on a specific platform by clicking the cell link.
			Normally, the number of errors is indicated in the cell.
		</p>
		<p>
			A negative number or "DNF" means the test "Did Not Finish" for unknown reasons and hence no results page is available.
			In that case, more information can sometimes be found in the <a href="testresults/logs.html#console">console logs</a>.
		</p>
		<table>
			<thead>
				<tr>
					<th rowspan="2">org.eclipse<br />Test Bundles</th>
					<th id="tests-header" colspan="1" style="text-align: center">Test Configurations (os.ws.arch/VM)</th>
				</tr>
				<tr id="test-configurations-headline">
					<!-- Expected configurations are injected dynamically below-->
				</tr>
			</thead>
			<tbody id="test-results-summary"></tbody>
		</table>

		<h3 id="compiler-problems">Plugins containing compile errors or warnings</h3>
		<p>
			The table below shows the plugins in which errors or warnings were encountered.
			Click on the jar file link to view its detailed report.
		</p>
		<table>
			<thead>
				<tr>
					<th>Compile Logs (Jar Files)</th>
					<th style="text-align: center">Errors</th>
					<th style="text-align: center">Warnings</th>
				</tr>
			</thead>
			<tbody id="compiler-warnings-summary"></tbody>
		</table>

		<h3>Plugins containing access errors or warnings</h3>
		<table>
			<thead>
				<tr>
					<th>Compile Logs (Jar Files)</th>
					<th style="text-align: center">Forbidden Access</th>
					<th style="text-align: center">Discouraged Access</th>
					<th style="text-align: center">Info Warnings</th>
				</tr>
			</thead>
			<tbody id="compiler-access-summary"></tbody>
		</table>
	</main>

	<script>
		loadPageData('buildproperties.json')
		const compilerSummary = fetch('compilerSummary.json').then(r => r.json())

		contentPostProcessor = (mainElement, build) => {
			document.title += ` for ${build.label}`
			document.getElementById('ci-tests-folder-url').href = getJenkinsTestJobsFolderURL(build)
			injectTestResultsSummaryTable(build)
			compilerSummary.then(sum => injectCompilerSummaryTable(sum))
		}

		function injectTestResultsSummaryTable(build) {
			const testResultsSummaries = fetchAllTestSummaryFiles(build, 'testresults/')
			const testResultsTable = document.getElementById('test-results-summary')
			const testsHeadlineCell = document.getElementById('tests-header')
			const testConfigsHeadline = document.getElementById('test-configurations-headline')
			const expectedTestConfigsCount = build.expectedTests.length
			testsHeadlineCell.colSpan = expectedTestConfigsCount
			const expectedTestsLongNames = []
			for (const testConfig of build.expectedTests) {
				const [os, ws, arch, javaVersion] = parseTestConfiguration(testConfig)
				const headerCell = document.createElement('th');
				headerCell.innerHTML = `${getOSLabel(os)}<br/>${getCPUArchLabel(arch)}<br/>Java ${javaVersion}`
				headerCell.style = 'text-align:center'
				testConfigsHeadline.appendChild(headerCell)
				expectedTestsLongNames.push(getLongTestConfigurationName(testConfig, build))
			}
			testResultsSummaries.then(testSummaries => {
				const allTestNames = new Set();
				for (const testSummary of testSummaries) {
					const names = Object.keys(testSummary)
					names.forEach(n => allTestNames.add(n))
				}
				const sortedTestNames = Array.from(allTestNames)
				sortedTestNames.sort()
				for (const testName of sortedTestNames) {
					const testRow = testResultsTable.insertRow()
					insertLeanCell(testRow).innerHTML = testName.replace(/^org\.eclipse\./, '')
					for (let t = 0; t < expectedTestConfigsCount; t++) {
						const testResult = testSummaries[t][testName]

						let cellHTML = '';
						if (testResult) {
							const filename = `${testName}_${expectedTestsLongNames[t]}`
							const color = testResult.errors == 0 ? 'inherit' : 'red'
							cellHTML = `
							<a style="color:${color}" title="Detailed Unit Test Results Table" href="testresults/html/${filename}.html">(${testResult.errors})</a>
							<a style="color:darkgray" title="XML Test Result (e.g. for importing into the Eclipse JUnit view)" href="testresults/xml/${filename}.xml">(XML)</a>
							`
						}
						insertLeanCell(testRow, true).innerHTML = cellHTML
					}
				}
				//TODO: The number of executed/skipped cases per suite/plugin could also be displayed?
			})
		}

		function injectCompilerSummaryTable(compilerSummary) {
			const generalIssues = document.getElementById('compiler-warnings-summary')
			const accessIssues = document.getElementById('compiler-access-summary')
			for (const pluginName in compilerSummary) {
				const issues = compilerSummary[pluginName]
				const basicLink = `compilelogs/plugins/${issues.path}`
				if (issues.errors || issues.warnings) {
					const row = generalIssues.insertRow()
					addLinkCell(row, basicLink, null, pluginName)
					addLinkCell(row, basicLink, 'ERRORS', issues.errors)
					addLinkCell(row, basicLink, 'OTHER_WARNINGS', issues.warnings)
				}
				if (issues.forbidden || issues.discouraged || issues.infos) {
					const row = accessIssues.insertRow()
					addLinkCell(row, basicLink, null, pluginName)
					addLinkCell(row, basicLink, 'FORBIDDEN_WARNINGS', issues.forbidden)
					addLinkCell(row, basicLink, 'DISCOURAGED_WARNINGS', issues.discouraged)
					addLinkCell(row, basicLink, 'INFO_WARNINGS', issues.infos)
				}
			}

			function addLinkCell(row, basicLink, fragment, value) {
				const link = basicLink + (fragment ? ('#' + fragment) : '')
				insertLeanCell(row, Boolean(fragment)).innerHTML = `<a href="${link}">${value ? value : 0}</a>`
			}
		}

		function insertLeanCell(row, center) {
			const cell = row.insertCell()
			cell.style = `padding-bottom:1px; padding-top:1px; ${center ? 'text-align:center' : ''}`
			return cell
		}

		generate()

	</script>
</body>

</html>